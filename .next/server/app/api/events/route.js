"use strict";(()=>{var e={};e.id=3873,e.ids=[3873],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},52033:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>g,patchFetch:()=>h,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>v,staticGenerationAsyncStorage:()=>u});var o={};n.r(o),n.d(o,{GET:()=>c,POST:()=>l});var r=n(36126),s=n(69184),i=n(36197),a=n(30482);async function c(){try{let e=await a.Z.event.findMany({orderBy:{date:"desc"}});if(!e||0===e.length)return new Response(JSON.stringify([]),{status:200,headers:{"Content-Type":"application/json"}});let t=await Promise.all(e.map(async e=>{let t=await a.Z.victim.count({where:{eventID:e.eventID}}),n=0,o=0;if(e.location)try{console.log(`Fetching geolocation for: ${e.location}`);let t=await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(e.location)}&key=AIzaSyBovaBCHwuifoLoksenhZWnafUbhQZl7Uw`,{timeout:5e3});if(!t.ok)throw Error(`Geocoding API error: ${t.status}`);let r=await t.json();"OK"===r.status&&r.results&&r.results.length>0?(n=r.results[0].geometry.location.lat,o=r.results[0].geometry.location.lng):console.error(`Geocoding failed for ${e.location}:`,r.status)}catch(t){console.error(`Error geocoding location "${e.location}":`,t)}return{eventID:e.eventID,date:e.date,description:e.description,location:e.location,victimCount:t,lat:n,lng:o}}));return new Response(JSON.stringify(t),{status:200,headers:{"Content-Type":"application/json"}})}catch(e){return console.error("GET /api/events error:",e),new Response(JSON.stringify({error:"Failed to fetch events."}),{status:500,headers:{"Content-Type":"application/json"}})}}async function l(e){try{let t;let n=await e.json();if(!n)return new Response(JSON.stringify({error:"Request body is missing"}),{status:400,headers:{"Content-Type":"application/json"}});let{date:o,description:r,location:s}=n,i=await a.Z.event.findFirst({where:{AND:[r?{description:r}:{},s?{location:s}:{},o?{date:new Date(o)}:{}]}});if(i)return new Response(JSON.stringify({message:"An event with this information already exists. Using existing record.",eventID:i.eventID,event:i,isExisting:!0}),{status:200,headers:{"Content-Type":"application/json"}});try{t=await a.Z.event.create({data:{date:o?new Date(o):null,description:r||"",location:s||null}})}catch(e){if("P2002"===e.code){console.log("Handling potential race condition during event creation");let e=await a.Z.event.findFirst({where:{AND:[r?{description:r}:{},s?{location:s}:{},o?{date:new Date(o)}:{}]},orderBy:{eventID:"desc"}});if(e)return new Response(JSON.stringify({message:"An event with this information was just created. Using existing record.",eventID:e.eventID,event:e,isExisting:!0}),{status:200,headers:{"Content-Type":"application/json"}});let n=await a.Z.event.findFirst({orderBy:{eventID:"desc"},select:{eventID:!0}}),i=n?n.eventID+1:1;try{t=await a.Z.event.create({data:{eventID:i,date:o?new Date(o):null,description:r||"",location:s||null}})}catch(e){throw console.error("Second attempt to create event failed:",e),e}}else throw e}return new Response(JSON.stringify({message:"Event created successfully",eventID:t.eventID,event:t,isExisting:!1}),{status:201,headers:{"Content-Type":"application/json"}})}catch(e){if(console.error("POST /api/events error:",e),"P2002"===e.code)return new Response(JSON.stringify({error:"An event with this information already exists.",details:"Please try again with different information."}),{status:409,headers:{"Content-Type":"application/json"}});return new Response(JSON.stringify({error:"Failed to create event.",details:e.message}),{status:500,headers:{"Content-Type":"application/json"}})}}let p=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/events/route",pathname:"/api/events",filename:"route",bundlePath:"app/api/events/route"},resolvedPagePath:"/Users/tazkia/Desktop/Uddhar/app/api/events/route.js",nextConfigOutput:"",userland:o}),{requestAsyncStorage:d,staticGenerationAsyncStorage:u,serverHooks:v}=p,g="/api/events/route";function h(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:u})}},30482:(e,t,n)=>{n.d(t,{Z:()=>o});let o=new(n(53524)).PrismaClient},36126:(e,t,n)=>{e.exports=n(30517)}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),o=t.X(0,[9576],()=>n(52033));module.exports=o})();